#!/usr/bin/env bash

createZdevice() {
	echo "createZdevice: Beginning creation of zDevice."
	if ! [[ -d "/sys/class/zram-control" ]]; then
		modprobe --verbose zram >> "$ZLOG" 2>&1 || return 1
	fi

	RAM_DEV="$(zramctl --find --size "$DISK_SIZE" --algorithm "$ALG" | tr -dc '0-9')"

	if [[ -z $RAM_DEV ]]; then
		echo "createZdevice: Failed to find an open zram device, trying one more time!" >> "$ZLOG"
		RAM_DEV="$(zramctl --find --size "$DISK_SIZE" --algorithm "$ALG" | tr -dc '0-9')"
		if [[ -z $RAM_DEV ]]; then
			echo "createZdevice: Failed to find an open zram device. Exiting!" | tee -a "$ZLOG"
			return 1
		fi
	fi

	echo "$MEM_SIZE" > "/sys/block/zram${RAM_DEV}/mem_limit"
	if [[ $MEM_SIZE == 0 ]]; then
		echo "createZdevice: zram${RAM_DEV} no mem_limit" >> "$ZLOG"
	fi

	echo "createZdevice: zram${RAM_DEV} created comp_algorithm=${ALG} mem_limit=${MEM_SIZE} disksize=${DISK_SIZE}." >> "$ZLOG"
}

createZswap() {
	echo "createZswap: Beginning creation of zswap device." >> "$ZLOG"
	createZdevice || return 1
	mkswap --label "zram-config${RAM_DEV}" "/dev/zram${RAM_DEV}" >> "$ZLOG" 2>&1 || return 1

	if [[ -n $PRIORITY ]]; then
		swapon -v -p "$PRIORITY" "/dev/zram${RAM_DEV}" >> "$ZLOG" 2>&1 || return 1
	else
		echo "createZswap: No swap priority provided for zram${RAM_DEV}. Exiting!" | tee -a "$ZLOG"
		return 1
	fi

	if [[ -n $PAGE_CLUSTER ]]; then
		sysctl vm.page-cluster="$PAGE_CLUSTER" >> "$ZLOG" 2>&1 || return 1
	else
		echo "createZswap: zram${RAM_DEV} no page_cluster" >> "$ZLOG"
	fi

	if [[ -n $SWAPPINESS ]]; then
		sysctl vm.swappiness="$SWAPPINESS" >> "$ZLOG" 2>&1 || return 1
	else
		echo "createZswap: zram${RAM_DEV} no swappiness" >> "$ZLOG"
	fi

	echo "swap		/zram${RAM_DEV}		zram-config${RAM_DEV}" >> "$TMPDIR"/zram-device-list
	echo "createZswap: Completed zswap device creation." >> "$ZLOG"
}

createZdir() {
	local dirPerm
	local dirUser
	local dirGroup
	local dirMountOpt
	local dirFSType

	if [[ -z $BIND_DIR ]]; then
		echo "createZdir: No bind directory provided in '/etc/ztab'. Exiting!" | tee -a "$ZLOG"
		return 1
	elif [[ -z $TARGET_DIR ]]; then
		echo "createZdir: No mount directory provided in '/etc/ztab'. Exiting!" | tee -a "$ZLOG"
		return 1
	fi

	echo "createZdir: Beginning creation of ${ZDIR}." >> "$ZLOG"
	mkdir -p "${ZDIR}${BIND_DIR}" >> "$ZLOG" 2>&1 || return 1

	dirPerm="$(stat -c "%a" "$TARGET_DIR")"
	dirUser="$(stat -c "%u" "$TARGET_DIR")"
	dirGroup="$(stat -c "%g" "$TARGET_DIR")"

	echo "createZdir: dirPerm - ${TARGET_DIR} ${dirPerm} ${dirUser}:${dirGroup}" >> "$ZLOG"

	mount --verbose --bind "${TARGET_DIR}/" "${ZDIR}${BIND_DIR}/" >> "$ZLOG" 2>&1 || return 1
	mount --verbose --make-private "${ZDIR}${BIND_DIR}/" >> "$ZLOG" 2>&1 || return 1

	dirMountOpt="$(awk -v a="${ZDIR}${BIND_DIR}" '$2 == a {print $4}' /proc/mounts | head -1)"
	dirFSType="$(awk -v a="${ZDIR}${BIND_DIR}" '$2 == a {print $3}' /proc/mounts | head -1)"

	echo "createZdir: dirMountOpt - ${dirMountOpt}; dirFsType: ${dirFSType}" >> "$ZLOG"
	createZdevice || return 1

	mke2fs -v -t "$dirFSType" "/dev/zram${RAM_DEV}" >> "$ZLOG" 2>&1 || return 1
	mkdir -p "${ZDIR}/zram${RAM_DEV}" >> "$ZLOG" 2>&1 || return 1
	mount --verbose --types "$dirFSType" -o "$dirMountOpt" "/dev/zram${RAM_DEV}" "${ZDIR}/zram${RAM_DEV}/" >> "$ZLOG" 2>&1 || return 1
	mkdir -p "${ZDIR}/zram${RAM_DEV}/upper" "${ZDIR}/zram${RAM_DEV}/workdir" "$TARGET_DIR" >> "$ZLOG" 2>&1 || return 1
	mount --verbose --types overlay -o "redirect_dir=on,lowerdir=${ZDIR}${BIND_DIR},upperdir=${ZDIR}/zram${RAM_DEV}/upper,workdir=${ZDIR}/zram${RAM_DEV}/workdir" "overlay${RAM_DEV}" "$TARGET_DIR" >> "$ZLOG" 2>&1 || return 1
	chown "${dirUser}:${dirGroup}" "${ZDIR}/zram${RAM_DEV}/upper" "${ZDIR}/zram${RAM_DEV}/workdir" "$TARGET_DIR" >> "$ZLOG" 2>&1 || return 1
	chmod "$dirPerm" "${ZDIR}/zram${RAM_DEV}/upper" "${ZDIR}/zram${RAM_DEV}/workdir" "$TARGET_DIR" >> "$ZLOG" 2>&1 || return 1

	echo "${ZTYPE}		/zram${RAM_DEV}		${TARGET_DIR}		${BIND_DIR}" >> "$TMPDIR"/zram-device-list

	if [[ $ZTYPE == "log" ]] && [[ -n $OLDLOG_DIR ]]; then
		echo -e "olddir ${OLDLOG_DIR}\\ncreateolddir 755 root root\\nrenamecopy" > /etc/logrotate.d/00_oldlog
	elif [[ $ZTYPE == "log" ]]; then
		echo "createZdir: No oldlog directory provided in '/etc/ztab', skipping oldlog configuration." >> "$ZLOG"
	fi
	echo "createZdir: Creation of ${ZDIR} complete." >> "$ZLOG"
}

mergeOverlay() {
	echo "mergeOverlay: Beginning merge of ${ZDIR}${BIND_DIR}." >> "$ZLOG"
	ls -la "$ZDIR" "${ZDIR}${BIND_DIR}" "${ZDIR}${ZRAM_DEV}/upper" >> "$ZLOG"
	cd /usr/local/lib/zram-config/ || return 1
	(./overlay merge --yes --lowerdir="${ZDIR}${BIND_DIR}" --upperdir="${ZDIR}${ZRAM_DEV}/upper") >> "$ZLOG" 2>&1 || return 1
	bash -x -- *.sh >> "$ZLOG" 2>&1
	rm -fv -- *.sh >> "$ZLOG" 2>&1 || return 1
	echo "mergeOverlay: Merge of ${ZDIR}${BIND_DIR} complete." >> "$ZLOG"
}

removeZdir() {
	local count=0

	[[ -n $OLDLOG_DIR ]] && rm -f /etc/logrotate.d/00_oldlog

	echo "removeZdir: Beginning removal of device /dev${ZRAM_DEV}." >> "$ZLOG"

	[[ -z $TARGET_DIR ]] && return 1
	if ! (umount --verbose "${TARGET_DIR}/" >> "$ZLOG" 2>&1); then
		[[ -x $(command -v lsof) ]] && lsof "${TARGET_DIR}/" >> "$ZLOG" 2>&1
		umount --verbose --lazy "${TARGET_DIR}/" >> "$ZLOG" 2>&1 || return 1
	fi

	mergeOverlay >> "$ZLOG" 2>&1 || return 1

	[[ -z $ZRAM_DEV ]] && return 1
	if ! (umount --verbose "${ZDIR}${ZRAM_DEV}/" >> "$ZLOG" 2>&1); then
		umount --verbose --lazy "${ZDIR}${ZRAM_DEV}/" >> "$ZLOG" 2>&1 || return 1
	fi
	rm -rfv "${ZDIR}${ZRAM_DEV}" >> "$ZLOG" 2>&1 || return 1

	[[ -z $BIND_DIR ]] && return 1
	if ! (umount --verbose "${ZDIR}${BIND_DIR}/" >> "$ZLOG" 2>&1); then
		umount --verbose --lazy "${ZDIR}${BIND_DIR}/" >> "$ZLOG" 2>&1 || return 1
	fi
	rm -rfv "${ZDIR}${BIND_DIR}" >> "$ZLOG" 2>&1 || return 1

	until zramctl -r "/dev${ZRAM_DEV}" >> "$ZLOG" 2>&1 || [[ count -ge 5 ]]; do
		count=$(( count + 1 ))
		sleep 5
  done

	echo "removeZdir: Device /dev$ZRAM_DEV removed." >> "$ZLOG"
}

removeZswap() {
	echo "removeZswap: Beginning removal of device /dev${ZRAM_DEV}." >> "$ZLOG"

	swapoff "/dev${ZRAM_DEV}" >> "$ZLOG" 2>&1 || return 1
	zramctl -r "/dev${ZRAM_DEV}" >> "$ZLOG" 2>&1 || return 1

	echo "removeZswap: Device /dev$ZRAM_DEV removed." >> "$ZLOG"
}

serviceConfiguration() {
	if [[ $1 == "stop" ]]; then
		echo "Stopping services that interfere with zram device configuration." >> "$ZLOG"
		if [[ $(systemctl is-active rsyslog.service) == "active" ]]; then
			export rsyslogActive="true"
			systemctl stop syslog.socket >> "$ZLOG" 2>&1 || return 1
		fi
		if [[ $(systemctl is-active systemd-journald.service) == "active" ]]; then
			export journaldActive="true"
			journalctl --flush >> "$ZLOG" 2>&1 || return 1
			systemctl stop systemd-journald.socket systemd-journald-audit.socket systemd-journald-dev-log.socket >> "$ZLOG" 2>&1 || return 1
		fi
	elif [[ $1 == "start" ]]; then
		echo "Restarting services that interfere with zram device configuration." >> "$ZLOG"
		if [[ -n $journaldActive ]]; then
			systemctl restart systemd-journald.socket systemd-journald-audit.socket systemd-journald-dev-log.socket >> "$ZLOG" 2>&1 || return 1
		fi
		if [[ -n $rsyslogActive ]]; then
			systemctl restart syslog.socket >> "$ZLOG" 2>&1 || return 1
		fi
	fi
}

TMPDIR="/tmp"
ZDIR="/opt/zram"
ZSHARE="/usr/local/share/zram-config"
ZLOG="${ZSHARE}/log/zram-config.log"
if [[ $2 == "shutdown" ]]; then
  SERVICE="1"
fi

case "$1" in
	start)
		echo "zram-config start $(date +%Y-%m-%d-%H:%M:%S)" | tee -a "$ZLOG"
		ZTAB_EMPTY="true"
		while read -r line; do
			case "$line" in
				"#"*)
					# Skip comment line
					continue
					;;

				"")
					# Skip empty line
					continue
					;;

				*)
					# shellcheck disable=SC2086
					set -- $line
					echo "ztab create ${1} ${2} ${3} ${4} ${5} ${6} ${7} ${8} ${9}" >> "$ZLOG"
					ZTAB_EMPTY="false"
					ZTYPE="$1"
					ALG="$2"
					MEM_SIZE="$3"
					DISK_SIZE="$4"
					if [[ -f "$TMPDIR"/zram-device-list ]]; then
						if [[ $1 == "swap" ]]; then
							entry="$(grep "^swap" "$TMPDIR"/zram-device-list)"
						else
							entry="$(grep "${1}.*${5}" "$TMPDIR"/zram-device-list)"
						fi
						if [[ -n $entry ]]; then
							echo "Entry ${entry} already exists as a zram device, skipping recreation of device." >> "$ZLOG"
							continue
						fi
					fi

					case "$1" in
						swap)
							PRIORITY="$5"
							PAGE_CLUSTER="$6"
							SWAPPINESS="$7"
							createZswap
							;;

						dir|log)
							TARGET_DIR="$5"
							BIND_DIR="$6"
							OLDLOG_DIR="$7"
							serviceConfiguration "stop"
							createZdir
							;;
					esac
					;;
			esac
		done < /etc/ztab
		if [[ $ZTAB_EMPTY == "true" ]]; then
			echo "Configuration file '/etc/ztab' is empty and needs to be configured. Exiting!" | tee -a "$ZLOG"
			exit 1
		fi
		;;

	stop)
		if [[ $(systemctl is-active zram-config.service) == "active" ]]; then
			if ! systemctl stop zram-config.service & systemctl kill zram-config.service >> "$ZLOG" 2>&1; then
		    echo "Failed to kill zram-config.service. Exiting!" | tee -a "$ZLOG"
				exit 1
			fi
		fi
		echo "zram-config stop $(date +%Y-%m-%d-%H:%M:%S)" | tee -a "$ZLOG"
		tac "$TMPDIR"/zram-device-list > "$TMPDIR"/zram-device-list.rev
		while read -r line; do
			case "$line" in
				"#"*)
					# Skip comment line
					continue
					;;

				"")
					# Skip empty line
					continue
					;;

				*)
					# shellcheck disable=SC2086
					set -- $line
					echo "ztab remove ${1} ${2} ${3} ${4}" >> "$ZLOG"
					case "$1" in
						swap)
							ZRAM_DEV="$2"
							removeZswap
							;;

						dir|log)
							ZRAM_DEV="$2"
							TARGET_DIR="$3"
							BIND_DIR="$4"
							[[ -z $SERVICE ]] && serviceConfiguration "stop"
							removeZdir
							;;
					esac
					;;
			esac
		done < "$TMPDIR"/zram-device-list.rev
		rm -fv "$TMPDIR"/zram-device-list.rev "$TMPDIR"/zram-device-list >> "$ZLOG"
		;;

	*)
		echo "Usage: zram-config {start|stop}"
		exit 0
		;;
esac
[[ -z $SERVICE ]] && serviceConfiguration "start"
