#!/usr/bin/expect -f

set retval 0
set timeout -1
set loginUser "pi"
set loginPassword "raspberry"

spawn bash

# Setup user
# expect "root@(none):/# "
# send "mount -o remount,rw /dev/mmcblk0p2 /\r"
# expect "root@(none):/# "
# send "passwd pi\r"
# expect "New password:"
# send "$loginPassword\r"
# expect "Retype new password:"
# send "$loginPassword\r"
# expect "root@(none):/# "
# send "sync\r"
# expect "root@(none):/# "
# send "uname -a; ls /boot; cat /boot/cmdline.txt; cat /etc/os-release; ls /lib/modules\r"
# expect "root@(none):/# "
# send "exec /sbin/init\r"
#
# # Login process
# expect {
#   "raspberrypi login: " {
#     send "$loginUser\r"
#     exp_continue
#   }
#   "Password: " {
#     send "$loginPassword\r"
#     exp_continue
#   }
#   "pi@raspberrypi:~$ " {
#     send "sudo date -s \"DATESED\"\r"
#   }
#   "Login incorrect" {
#     exit 1
#   }
# }

# Install tests
expect "$ "
send "sudo bash -c '/opt/zig/zig build --build-file /opt/zram-config/build.zig -Doptimize=ReleaseFast --summary all install --prefix /usr &> /var/log/zig-build.log'\r"
expect "$ "
send "sudo /usr/bin/zram-config create\r"
expect "$ "
send "sudo /usr/bin/zram-config service\r"
expect "$ "
send "sudo /usr/bin/zram-config start\r"
expect "$ "

# Stop tests
expect "$ "
send "sudo /usr/bin/zram-config stop\r"

# Shutdown

exit $retval
